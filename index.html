<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/style.css"/>
    <link rel="manifest" href="manifest.json"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'/>
    <link rel="stylesheet" href="/buttons.css"/>
    <link rel="stylesheet" href="/forms.css"/>
    <link rel="stylesheet" href="/popups.css"/>
    <script>
        
        async function requestLocationUpdate() {
            if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                async function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                console.log("Latitude:", lat);
                console.log("Longitude:", lon);

                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
                    if (response.ok) {
                    const data = await response.json();
                    const place = data.display_name || "Unknown location";
                    console.log("Location (place name):", place);
                    // Optionally, display on page:
                    document.querySelector('.notification').textContent = `You are at: ${place}`;
                    } else {
                    console.error("Failed to fetch place name.");
                    }
                } catch (err) {
                    console.error("Error during reverse geocoding:", err);
                }
                },
                function(error) {
                console.error("Error getting location:", error.message);
                document.querySelector('.notification').textContent = "Unable to get your location.";
                }
            );
            } else {
            console.error("Geolocation is not supported by this browser.");
            document.querySelector('.notification').textContent = "Geolocation is not supported by this browser.";
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            requestLocationUpdate();
        });
        if (navigator.permissions) {
            navigator.permissions.query({ name: 'geolocation' })
            .then(permissionStatus => {
                console.log('Geolocation permission status:', permissionStatus.state);
                permissionStatus.onchange = () => {
                    console.log('Geolocation permission changed to:', permissionStatus.state);
                };
            })
            .catch(error => {
                console.error('Error querying geolocation permission:', error);
            });
        } else {
            console.warn('Permissions API not supported in this browser.');
        }


        if ("vibrate" in navigator) {
            try {
                
                navigator.vibrate(200);
                console.log("Vibration permission requested.");
            } catch (e) {
                console.error("Vibration not permitted or failed:", e);
            }
        } else {
            console.log("Vibration API not supported.");
        }
        

        if ('caches' in window) {
            caches.open('orion-cache').then(cache => {
                cache.addAll([
                    '/index.html',
                    '/style.css',
                    '/app.js',
                    '/manifest.json',
                    '/icon.png',
                    '/buttons.css',
                    '/forms.css',
                    '/popups.css'
                ]).then(() => {
                    console.log('Assets cached successfully.');
                }).catch(error => {
                    console.error('Failed to cache assets:', error);
                });
            });
        } else {
            console.warn('Cache API not supported in this browser.');
        }

        async function postUserGeolocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    async function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        try {
                            await fetch('/dash.html', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ latitude: lat, longitude: lon })
                            });
                            console.log('Geolocation posted to dash.html');
                        } catch (err) {
                            console.error('Failed to post geolocation:', err);
                        }
                    },
                    function(error) {
                        console.error("Error getting location for posting:", error.message);
                    }
                );
            } else {
                console.error("Geolocation is not supported by this browser.");
            }
        }
        postUserGeolocation();

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
            });
        } else {
            console.warn('Service Workers are not supported in this browser.');
        }
        let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        window.addEventListener('appinstalled', async () => {
            let deviceDetails = `${navigator.platform} (${navigator.userAgent})`;
            let place = "your location";
            if ("geolocation" in navigator) {
                try {
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject);
                    });
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
                    if (resp.ok) {
                        const data = await resp.json();
                        place = data.display_name || place;
                    }
                } catch (e) {
                    // Ignore geolocation errors
                }
            }
            if ('Notification' in window && Notification.permission === 'granted' && navigator.serviceWorker) {
                navigator.serviceWorker.ready.then(reg => {
                    reg.showNotification('Plaxedas Installed', {
                        body: `Plaxedas has been successfully installed on your ${deviceDetails} in ${place}.`,
                        icon: '/ff.png'
                    });
                });
            }
        });
        window.addEventListener('load', () => {
            if (window.matchMedia('(display-mode: standalone)').matches) return;
            if ('BeforeInstallPromptEvent' in window) return; // Already handled below

            let installPromptShown = false;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                if (installPromptShown) return;
                installPromptShown = true;
                const installBtn = document.createElement('button');
                installBtn.textContent = 'Install this App';
                installBtn.className = 'install-btn';
                installBtn.style.position = 'fixed';
                installBtn.style.bottom = '20px';
                installBtn.style.right = '20px';
                installBtn.style.zIndex = '1000';
                document.body.appendChild(installBtn);

                installBtn.addEventListener('click', async () => {
                    installBtn.style.display = 'none';
                    e.prompt();
                    await e.userChoice;
                });
            });
        });
            installBtn.addEventListener('click', async () => {
                installBtn.style.display = 'none';
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                } else {
                    console.log('User dismissed the install prompt');
                }
                deferredPrompt = null;
            });
        



        if ('Notification' in window && navigator.serviceWorker) {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.showNotification('Welcome to the plaxedas!', {
                            body: 'Your secure and private space for all kinds of shopping and service.',
                            icon: '/ff.png'
                        });
                    });
                } else {
                    console.warn('Notification permission denied.');
                }
            });
        } else {
            console.warn('Notifications are not supported in this browser.');
        }

        if (window.location.protocol === 'http:') {
            console.warn('Running on HTTP. For full functionality, consider using HTTPS.');
        } else {
            console.log('Running on secure HTTPS protocol.');
        }

        if (window.location.protocol === 'https:') {
            console.log('Secure connection established.');
        } else {
            console.warn('Insecure connection. Some features may not work properly.');
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(async () => {
                // Check if app is installed (standalone mode)
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
                if (!isStandalone) {
                    // Request notification permission if not already granted
                    if ('Notification' in window && navigator.serviceWorker) {
                        let permission = Notification.permission;
                        if (permission !== 'granted') {
                            try {
                                permission = await Notification.requestPermission();
                            } catch (e) {
                                console.warn('Notification permission request failed:', e);
                            }
                        }
                        if (permission === 'granted') {
                            navigator.serviceWorker.ready.then(reg => {
                                reg.showNotification('Install Plaxedas', {
                                    body: 'Install Plaxedas for a better experience. Tap to install!',
                                    icon: '/ff.png',
                                    requireInteraction: true, // Keeps the notification until user interacts
                                    data: { url: window.location.href },
                                    actions: [
                                        { action: 'install', title: 'Install Now' }
                                    ]
                                });
                            });
                        }
                    }
                }
            }, 10000);
        });

        // Optional: Handle notification click to prompt install
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(reg => {
                if (reg.active) {
                    reg.active.addEventListener('notificationclick', function(event) {
                        if (event.action === 'install' || event.notification) {
                            event.notification.close();
                            if (typeof deferredPrompt !== 'undefined' && deferredPrompt) {
                                deferredPrompt.prompt();
                                deferredPrompt.userChoice.then(() => {
                                    deferredPrompt = null;
                                });
                            } else {
                                window.open(window.location.href, '_blank');
                            }
                        }
                    });
                }
            });
        }

        

    </script>
    <title>plaxedas</title>
    
</head>
<body>
    <header class="app-header"></header>
    <section class="app"></section>
    <main class="app-main"></main>
    <section class="notification"></section>
    <br><br><br><br><br><br>
    <footer class="app-footer"></footer>
    <script src="/app.js"></script>
    <script src="/form.js"></script>
    <script src="/popups.js"></script>
    <script src="/buttons.js"></script>
    <script src="/regulators.js"></script>
    

    
</body>
</html>
